<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>UniVerse | Complete Profile</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-50 min-h-screen flex items-center justify-center p-4">

  <div class="bg-white w-full max-w-lg rounded-xl shadow p-6">
    <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">
      Complete Your Profile
    </h2>

    <form id="profileForm" class="space-y-5">

      <!-- Affiliation Type -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Affiliation
        </label>
        <select id="affiliation" class="w-full border rounded-lg p-2" required>
          <option value="">Select</option>
          <option value="student">Student</option>
          <option value="non-student">Non-student</option>
        </select>
      </div>

      <!-- Student Fields -->
      <div id="studentFields" class="hidden space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">
            University
          </label>
          <select id="university" class="w-full border rounded-lg p-2">
            <option value="">Select University</option>
            <option>University of Ghana</option>
            <option>KNUST</option>
            <option>UCC</option>
            <option>UEW</option>
            <option>UDS</option>
            <option>Other</option>
          </select>
        </div>
      </div>

      <!-- Create Store Option -->
      <div id="storeOption" class="hidden">
        <label class="inline-flex items-center">
          <input type="checkbox" id="createStore" class="mr-2">
          Create a store after saving profile
        </label>
      </div>

      <button
        type="submit"
        class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">
        Save Profile
      </button>

    </form>
  </div>

<script>
  const affiliationSelect = document.getElementById("affiliation");
  const studentFields = document.getElementById("studentFields");
  const storeOption = document.getElementById("storeOption");
  const profileForm = document.getElementById("profileForm");

  const user = JSON.parse(localStorage.getItem("user"));
  const store = JSON.parse(localStorage.getItem("store"));
  const userHasStore = !!store;

  if (!user || !user.id) {
    alert("You must be logged in");
    window.location.href = "login.html";
  }

  affiliationSelect.addEventListener("change", () => {
    studentFields.classList.toggle(
      "hidden",
      affiliationSelect.value !== "student"
    );

    if (!userHasStore) {
      storeOption.classList.remove("hidden");
    }
  });

  profileForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    const affiliation = affiliationSelect.value;
    const university = document.getElementById("university").value || null;
    const wantsStore = document.getElementById("createStore")?.checked;

    try {
      const res = await fetch(
        "https://universe-api-uabt.onrender.com/api/auth/google/user/completeProfile",
        {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            userId: user.id,
            affiliation,
            university
          })
        }
      );

      const data = await res.json();

      if (!res.ok) {
        alert(data.message || "Failed to update profile");
        return;
      }

      // ✅ Update localStorage with latest user info
      localStorage.setItem("user", JSON.stringify(data.user));

      // ✅ Redirect logic
      if (wantsStore && !userHasStore) {
        window.location.href = "createStore.html";
      } else {
        window.location.href = "profile.html";
      }

    } catch (err) {
      console.error("Profile update failed:", err);
      alert("Something went wrong. Try again.");
    }
  });
</script>

</body>
</html>
